# Vue Router 菜单选中状态问题解决方案

## 问题描述

在使用 Vue Router 的应用中，常见的问题是某些菜单项会在访问其子路由时错误地保持选中状态。例如，`/my` 路径的菜单项在访问 `/my/products` 或 `/my/cart` 等子路由时仍然显示为选中状态。

## 解决方案概述

解决这个问题需要综合考虑路由配置和导航组件的实现，主要有以下几个关键点：

1. 路由配置优化
2. 精确匹配设置
3. 导航组件增强

## 详细实现步骤

### 1. 修改路由配置

在 `router/index.ts` 中，将父路径设置为重定向而非实际组件：

```typescript
{
  path: "/my",
  component: () => import("@/layouts/MyLayout.vue"),
  meta: { requiresAuth: true, role: "b&s" },
  children: [
    {
      path: "",
      name: "MyDashboard",
      redirect: "/my/profile", // 重定向到具体页面
    },
    {
      path: "profile",
      name: "MyProfile",
      component: () => import("@/modules/user/views/ProfileView.vue"),
    },
    // 其他子路由
  ]
}
```

### 2. 扩展导航组件的菜单项接口

在 `Navigation.vue` 中扩展 `MenuItem` 接口，添加精确匹配选项：

```typescript
export interface MenuItem {
  key: string
  label?: string
  labelKey?: string // i18n key
  to?: string
  exact?: boolean // 是否需要精确匹配
  children?: MenuItem[]
  [key: string]: any // 允许扩展属性
}
```

### 3. 修改导航组件的激活逻辑

在 `Navigation.vue` 中修改 `isItemActive` 方法，优先处理精确匹配：

```typescript
const isItemActive = (item: MenuItem): boolean => {
  if (!item.to) return false
  
  // 如果要求精确匹配，则只匹配完全相同的路径
  if (item.exact) {
    return item.to === route.path
  }
  
  // 精确匹配路由路径
  if (item.to === route.path) return true
  
  // 对于根路径，只有完全匹配才激活
  if (item.to === '/') {
    return route.path === '/'
  }
  
  // 如果菜单项包含查询参数，检查它们是否匹配
  if (item.to.includes('?')) {
    const [path, query] = item.to.split('?')
    const queryParams = new URLSearchParams(query)
    
    // 检查路径部分是否匹配
    if (!route.path.startsWith(path)) return false
    
    // 检查每个查询参数是否在当前路由中匹配
    for (const [key, value] of queryParams.entries()) {
      if (route.query[key] !== value) return false
    }
    
    return true
  }
  
  // 对于其他路径，检查是否为子路由
  if (route.path.startsWith(item.to + '/')) {
    return true
  }
  
  return false
}
```

### 4. 更新菜单配置

在菜单配置中，为需要精确匹配的项添加 `exact: true` 属性：

```typescript
const menuItems = ref<MenuItem[]>([
  {
    key: 'Profile',
    label: '我的信息',
    to: '/my/profile', // 使用具体路径
    exact: true // 表示需要精确匹配
  },
  {
    key: 'MyOrders',
    label: '我的订单',
    to: '/my/orders'
  },
  // 其他菜单项
]);
```

## 技术要点解析

1. **精确匹配 vs 前缀匹配**：
   - Vue Router 默认使用前缀匹配 (prefix matching)，导致父路径会匹配所有子路径
   - 添加 `exact` 选项可以强制精确匹配，只有完全相同的路径才会激活

2. **路由重定向**：
   - 使用重定向可以保持 URL 结构清晰，同时避免空路径匹配问题
   - 重定向不会影响导航组件的匹配逻辑

3. **路由匹配优先级**：
   - 精确匹配 > 查询参数匹配 > 子路由匹配

## 应用场景

这个解决方案适用于以下场景：

- 多级导航菜单
- 带有子路由的复杂应用
- 需要精确控制菜单高亮状态的场景

## 效果

实施该解决方案后，导航菜单将只在用户访问精确对应的路径时显示选中状态，避免了父级菜单项错误高亮的问题。

---

该解决方案基于 Vue 3 和 Vue Router 4，适用于大多数基于 Vue 的单页应用。根据项目的具体需求，可能需要进行适当调整。